<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Excel Combiner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* [Styles remain exactly the same as before] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }
        .upload-area:hover { border-color: #764ba2; background: #f0f2ff; }
        .upload-area.drag-over { border-color: #764ba2; background: #e8ebff; transform: scale(1.02); }
        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        .upload-text { color: #667eea; font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .upload-hint { color: #999; font-size: 14px; }
        #fileInput { display: none; }
        .file-list { margin-top: 30px; }
        .file-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .file-name { color: #333; font-weight: 500; }
        .file-info { color: #666; font-size: 12px; margin-top: 4px; }
        .remove-btn {
            background: #ff4757; color: white; border: none; padding: 8px 16px;
            border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.3s;
        }
        .remove-btn:hover { background: #ff3838; }
        .actions { margin-top: 30px; display: flex; gap: 15px; }
        button {
            flex: 1; padding: 15px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        .combine-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .combine-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
        .combine-btn:disabled { background: #ccc; cursor: not-allowed; }
        .clear-btn { background: #f1f3f5; color: #495057; }
        .clear-btn:hover { background: #e9ecef; }
        .status { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; font-weight: 500; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .preview { margin-top: 20px; max-height: 300px; overflow: auto; border: 1px solid #dee2e6; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
        tr:hover { background: #f8f9ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† Smart Excel Combiner</h1>
        <p class="subtitle">Combines files by matching column names automatically</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Click to upload or drag and drop</div>
            <div class="upload-hint">Upload multiple Excel files (.xlsx, .xls)</div>
            <input type="file" id="fileInput" accept=".xlsx,.xls" multiple>
        </div>

        <div class="file-list" id="fileList"></div>

        <div class="actions">
            <button class="combine-btn" id="combineBtn" disabled>Combine & Download</button>
            <button class="clear-btn" id="clearBtn">Clear All</button>
        </div>

        <div id="status"></div>
        <div id="preview"></div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const combineBtn = document.getElementById('combineBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusDiv = document.getElementById('status');
        const previewDiv = document.getElementById('preview');

        let files = [];

        // --- Event Listeners (Same as before) ---
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const droppedFiles = Array.from(e.dataTransfer.files).filter(f => 
                f.name.endsWith('.xlsx') || f.name.endsWith('.xls')
            );
            addFiles(droppedFiles);
        });
        fileInput.addEventListener('change', (e) => {
            addFiles(Array.from(e.target.files));
            fileInput.value = '';
        });

        function addFiles(newFiles) {
            files = [...files, ...newFiles];
            updateFileList();
            combineBtn.disabled = files.length < 2;
        }

        function updateFileList() {
            if (files.length === 0) {
                fileList.innerHTML = '';
                return;
            }
            fileList.innerHTML = files.map((file, index) => `
                <div class="file-item">
                    <div>
                        <div class="file-name">üìÑ ${file.name}</div>
                        <div class="file-info">${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                    <button class="remove-btn" onclick="removeFile(${index})">Remove</button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            files.splice(index, 1);
            updateFileList();
            combineBtn.disabled = files.length < 2;
            statusDiv.innerHTML = '';
            previewDiv.innerHTML = '';
        }

        clearBtn.addEventListener('click', () => {
            files = [];
            updateFileList();
            combineBtn.disabled = true;
            statusDiv.innerHTML = '';
            previewDiv.innerHTML = '';
        });

        // --- NEW LOGIC STARTS HERE ---

        combineBtn.addEventListener('click', async () => {
            statusDiv.innerHTML = '<div class="status info">Reading and aligning columns...</div>';
            previewDiv.innerHTML = '';

            try {
                let allRows = [];
                let uniqueHeaders = new Set();

                // 1. Read all files and convert to JSON Objects
                for (const file of files) {
                    const data = await readExcelFile(file);
                    
                    // Collect all unique headers from this file
                    if (data.length > 0) {
                        Object.keys(data[0]).forEach(h => uniqueHeaders.add(h));
                        allRows.push(...data);
                    }
                }

                // Convert Set to Array for SheetJS
                const headerArray = Array.from(uniqueHeaders);

                // 2. Write to Sheet
                // json_to_sheet with 'header' option forces the column order and alignment
                const ws = XLSX.utils.json_to_sheet(allRows, { header: headerArray });
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Combined');

                // 3. Download
                const fileName = `smart_combined_${new Date().getTime()}.xlsx`;
                XLSX.writeFile(wb, fileName);

                statusDiv.innerHTML = `<div class="status success">‚úÖ Successfully merged ${files.length} files! Columns aligned automatically.</div>`;
                
                showPreview(headerArray, allRows.slice(0, 10));

            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        });

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // key change: convert to JSON objects (key-value pairs) instead of arrays
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(new Error(`Error reading ${file.name}: ${error.message}`));
                    }
                };

                reader.onerror = () => reject(new Error(`Failed to read ${file.name}`));
                reader.readAsArrayBuffer(file);
            });
        }

        function showPreview(headers, rows) {
            if (rows.length === 0) return;

            const table = `
                <table>
                    <thead>
                        <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        ${rows.map(row => `
                            <tr>${headers.map(header => `<td>${row[header] || ''}</td>`).join('')}</tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            previewDiv.innerHTML = `<h3 style="margin-bottom: 10px; color: #333;">Preview (aligned columns)</h3>${table}`;
        }
    </script>
</body>
</html>
