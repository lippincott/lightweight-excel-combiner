<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Excel & CSV Combiner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
        h2 { color: #333; margin: 30px 0 15px; font-size: 22px; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }
        .upload-area:hover { border-color: #764ba2; background: #f0f2ff; }
        .upload-area.drag-over { border-color: #764ba2; background: #e8ebff; transform: scale(1.02); }
        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        .upload-text { color: #667eea; font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .upload-hint { color: #999; font-size: 14px; }
        #fileInput { display: none; }
        .file-list { margin-top: 30px; }
        .file-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideIn 0.3s;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .file-name { color: #333; font-weight: 500; }
        .file-info { color: #666; font-size: 12px; margin-top: 4px; }
        .remove-btn {
            background: #ff4757; color: white; border: none; padding: 8px 16px;
            border-radius: 6px; cursor: pointer; font-size: 14px; transition: background 0.3s;
        }
        .remove-btn:hover { background: #ff3838; }
        .actions { margin-top: 30px; display: flex; gap: 15px; flex-wrap: wrap; }
        button {
            padding: 15px 20px; border: none; border-radius: 8px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        .combine-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; flex: 1; min-width: 200px; }
        .combine-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
        .combine-btn:disabled { background: #ccc; cursor: not-allowed; }
        .clear-btn { background: #f1f3f5; color: #495057; flex: 1; min-width: 200px; }
        .clear-btn:hover { background: #e9ecef; }
        .select-btn { background: #20c997; color: white; }
        .select-btn:hover { background: #17a589; transform: translateY(-2px); }
        .export-btn { background: #ff6b6b; color: white; }
        .export-btn:hover { background: #ee5a52; transform: translateY(-2px); }
        .export-word-btn { background: #0d6efd; color: white; }
        .export-word-btn:hover { background: #0b5ed7; transform: translateY(-2px); }
        .clear-report-btn { background: #6c757d; color: white; }
        .clear-report-btn:hover { background: #5a6268; transform: translateY(-2px); }
        
        .status { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; font-weight: 500; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        
        .table-container { margin-top: 20px; max-height: 400px; overflow: auto; border: 1px solid #dee2e6; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { 
            background: #f8f9fa; 
            font-weight: 600; 
            position: sticky; 
            top: 0; 
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }
        th:hover { background: #e9ecef; }
        th.sorted-asc::after { content: " ‚ñ≤"; color: #667eea; }
        th.sorted-desc::after { content: " ‚ñº"; color: #667eea; }
        
        tr:hover { background: #f8f9ff; }
        .checkbox-cell { width: 40px; text-align: center; }
        input[type="checkbox"] { cursor: pointer; width: 18px; height: 18px; }
        .report-section { margin-top: 40px; padding-top: 40px; border-top: 2px solid #dee2e6; }
        .report-table { background: #f8f9ff; padding: 20px; border-radius: 8px; min-height: 200px; }
        .report-row {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .report-row:hover { border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); }
        .report-row.dragging { opacity: 0.5; }
        .drag-handle { color: #999; margin-right: 10px; cursor: grab; font-size: 20px; }
        .drag-handle:active { cursor: grabbing; }
        .report-content { flex: 1; }
        .report-label { font-weight: 600; color: #667eea; margin-bottom: 5px; }
        .report-data { color: #333; font-size: 14px; }
        .delete-report-btn {
            background: #ff4757; color: white; border: none; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; font-size: 12px;
        }
        .delete-report-btn:hover { background: #ff3838; }
        .empty-report { text-align: center; color: #999; padding: 40px; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† Smart Excel & CSV Combiner</h1>
        <p class="subtitle">Combine files, sort data, select rows, and build official reports</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Click to upload or drag and drop</div>
            <div class="upload-hint">Upload multiple Excel (.xlsx, .xls) or CSV files</div>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" multiple>
        </div>

        <div class="file-list" id="fileList"></div>

        <div class="actions">
            <button class="combine-btn" id="combineBtn" disabled>Combine & View Data</button>
            <button class="clear-btn" id="clearBtn">Clear All</button>
        </div>

        <div id="status"></div>

        <div id="combinedSection" style="display: none;">
            <h2>üìä Combined Data</h2>
            <p style="margin-bottom: 10px; color: #666; font-size: 14px;">‚ÑπÔ∏è Click column headers to sort. Selections are saved while sorting.</p>
            <div class="button-group" style="margin-bottom: 15px;">
                <button class="select-btn" id="selectAllBtn">‚úì Select All</button>
                <button class="select-btn" id="deselectAllBtn">‚úó Deselect All</button>
                <button class="select-btn" id="addToReportBtn">Add Selected to Report</button>
            </div>
            <div class="table-container" id="combinedTableContainer"></div>
        </div>

        <div id="reportSection" class="report-section" style="display: none;">
            <h2>üìù Report Builder</h2>
            <div class="button-group" style="margin-bottom: 15px;">
                <button class="export-btn" id="exportExcelBtn">üì• Export to Excel</button>
                <button class="export-word-btn" id="exportWordBtn">üìÑ Export to Word (.docx)</button>
                <button class="clear-report-btn" id="clearReportBtn">üóëÔ∏è Clear Report</button>
            </div>
            <div class="report-table" id="reportTable">
                <div class="empty-report">No items in report yet. Select rows above and click "Add Selected to Report"</div>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const combineBtn = document.getElementById('combineBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusDiv = document.getElementById('status');
        const combinedSection = document.getElementById('combinedSection');
        const reportSection = document.getElementById('reportSection');
        const combinedTableContainer = document.getElementById('combinedTableContainer');
        const reportTable = document.getElementById('reportTable');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const deselectAllBtn = document.getElementById('deselectAllBtn');
        const addToReportBtn = document.getElementById('addToReportBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const exportWordBtn = document.getElementById('exportWordBtn');
        const clearReportBtn = document.getElementById('clearReportBtn');

        let files = [];
        let combinedData = [];
        let headers = [];
        let reportItems = [];
        
        // Sorting and Selection State
        let sortState = { column: null, direction: 'asc' };
        let selectedRows = new Set(); // Stores IDs of checked rows

        // --- File Upload Logic ---
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            // Updated: filter now accepts CSV files
            const droppedFiles = Array.from(e.dataTransfer.files).filter(f => 
                f.name.endsWith('.xlsx') || f.name.endsWith('.xls') || f.name.toLowerCase().endsWith('.csv')
            );
            addFiles(droppedFiles);
        });
        fileInput.addEventListener('change', (e) => {
            addFiles(Array.from(e.target.files));
            fileInput.value = '';
        });

        function addFiles(newFiles) {
            files = [...files, ...newFiles];
            updateFileList();
            combineBtn.disabled = files.length < 1;
        }

        function updateFileList() {
            if (files.length === 0) {
                fileList.innerHTML = '';
                return;
            }
            fileList.innerHTML = files.map((file, index) => `
                <div class="file-item">
                    <div>
                        <div class="file-name">üìÑ ${file.name}</div>
                        <div class="file-info">${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                    <button class="remove-btn" onclick="removeFile(${index})">Remove</button>
                </div>
            `).join('');
        }

        window.removeFile = function(index) {
            files.splice(index, 1);
            updateFileList();
            combineBtn.disabled = files.length < 1;
        }

        clearBtn.addEventListener('click', () => {
            files = [];
            combinedData = [];
            headers = [];
            reportItems = [];
            selectedRows.clear();
            sortState = { column: null, direction: 'asc' };
            
            updateFileList();
            combineBtn.disabled = true;
            statusDiv.innerHTML = '';
            combinedSection.style.display = 'none';
            reportSection.style.display = 'none';
        });

        // --- Combine Logic ---
        combineBtn.addEventListener('click', async () => {
            statusDiv.innerHTML = '<div class="status info">Reading and aligning columns...</div>';

            try {
                let allRows = [];
                let uniqueHeaders = new Set();

                for (const file of files) {
                    const data = await readExcelFile(file);
                    if (data.length > 0) {
                        Object.keys(data[0]).forEach(h => uniqueHeaders.add(h));
                        allRows.push(...data);
                    }
                }

                headers = Array.from(uniqueHeaders);
                // Assign unique ID to each row for tracking
                combinedData = allRows.map((row, index) => ({ ...row, _id: index }));

                statusDiv.innerHTML = `<div class="status success">‚úÖ Successfully merged ${files.length} file(s) with ${combinedData.length} rows!</div>`;
                
                renderCombinedTable();
                combinedSection.style.display = 'block';

            } catch (error) {
                console.error(error);
                statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        });

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        // XLSX.read handles CSV files automatically when passed as array buffer
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(new Error(`Error reading ${file.name}: ${error.message}`));
                    }
                };
                reader.onerror = () => reject(new Error(`Failed to read ${file.name}`));
                reader.readAsArrayBuffer(file);
            });
        }

        // --- Sorting Logic ---
        window.toggleSort = function(column) {
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }

            combinedData.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                if (valA == null) valA = "";
                if (valB == null) valB = "";

                if (!isNaN(valA) && !isNaN(valB) && valA !== "" && valB !== "") {
                    valA = Number(valA);
                    valB = Number(valB);
                } else {
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return sortState.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortState.direction === 'asc' ? 1 : -1;
                return 0;
            });

            renderCombinedTable();
        };

        function renderCombinedTable() {
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th class="checkbox-cell" style="cursor: default"><input type="checkbox" id="masterCheckbox"></th>
                            ${headers.map(h => {
                                let sortClass = '';
                                if (sortState.column === h) {
                                    sortClass = sortState.direction === 'asc' ? 'sorted-asc' : 'sorted-desc';
                                }
                                return `<th class="${sortClass}" onclick="toggleSort('${h}')">${h}</th>`;
                            }).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${combinedData.map(row => `
                            <tr>
                                <td class="checkbox-cell">
                                    <input type="checkbox" class="row-checkbox" data-id="${row._id}" 
                                    ${selectedRows.has(row._id) ? 'checked' : ''} onchange="toggleRowSelection(${row._id}, this.checked)">
                                </td>
                                ${headers.map(header => `<td>${row[header] || ''}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            combinedTableContainer.innerHTML = table;

            const masterCheckbox = document.getElementById('masterCheckbox');
            if(masterCheckbox) {
                masterCheckbox.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.row-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                        const id = parseInt(cb.dataset.id);
                        toggleRowSelection(id, this.checked);
                    });
                });
            }
        }

        window.toggleRowSelection = function(id, isChecked) {
            if (isChecked) {
                selectedRows.add(id);
            } else {
                selectedRows.delete(id);
            }
        };

        selectAllBtn.addEventListener('click', () => {
            combinedData.forEach(row => selectedRows.add(row._id));
            renderCombinedTable();
        });

        deselectAllBtn.addEventListener('click', () => {
            selectedRows.clear();
            renderCombinedTable();
        });

        addToReportBtn.addEventListener('click', () => {
            selectedRows.forEach(id => {
                const row = combinedData.find(r => r._id === id);
                if (row && !reportItems.find(item => item._id === id)) {
                    reportItems.push({ ...row });
                }
            });

            renderReport();
            reportSection.style.display = 'block';
            
            // Clear selections after adding
            selectedRows.clear();
            renderCombinedTable();
        });

        // --- Report Logic ---
        function renderReport() {
            if (reportItems.length === 0) {
                reportTable.innerHTML = '<div class="empty-report">No items in report yet. Select rows above and click "Add Selected to Report"</div>';
                return;
            }

            reportTable.innerHTML = reportItems.map((item, index) => {
                const displayData = headers.map(h => `<strong>${h}:</strong> ${item[h] || 'N/A'}`).join(' | ');
                return `
                    <div class="report-row" draggable="true" data-index="${index}">
                        <span class="drag-handle">‚ò∞</span>
                        <div class="report-content">
                            <div class="report-label">Item ${index + 1}</div>
                            <div class="report-data">${displayData}</div>
                        </div>
                        <button class="delete-report-btn" onclick="deleteReportItem(${index})">‚úï</button>
                    </div>
                `;
            }).join('');

            setupDragAndDrop();
        }

        window.deleteReportItem = function(index) {
            reportItems.splice(index, 1);
            renderReport();
        }

        // NEW: Clear Report Button Logic
        clearReportBtn.addEventListener('click', () => {
            if (reportItems.length === 0) return;
            
            if (confirm('Are you sure you want to clear the entire report? This cannot be undone.')) {
                reportItems = [];
                renderReport();
            }
        });

        // --- Drag and Drop Logic ---
        function setupDragAndDrop() {
            const rows = document.querySelectorAll('.report-row');
            let draggedElement = null;

            rows.forEach(row => {
                row.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                row.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });

                row.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const afterElement = getDragAfterElement(reportTable, e.clientY);
                    if (afterElement == null) {
                        reportTable.appendChild(draggedElement);
                    } else {
                        reportTable.insertBefore(draggedElement, afterElement);
                    }
                });

                row.addEventListener('drop', function(e) {
                    e.preventDefault();
                    updateReportOrder();
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.report-row:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function updateReportOrder() {
            const rows = document.querySelectorAll('.report-row');
            const newOrder = [];
            rows.forEach(row => {
                const index = parseInt(row.dataset.index);
                newOrder.push(reportItems[index]);
            });
            reportItems = newOrder;
            renderReport();
        }

        // --- Export Logic ---
        exportExcelBtn.addEventListener('click', () => {
            if (reportItems.length === 0) return alert('No items in report to export');

            const ws = XLSX.utils.json_to_sheet(reportItems.map(item => {
                const cleanItem = { ...item };
                delete cleanItem._id;
                return cleanItem;
            }), { header: headers });
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Report');
            XLSX.writeFile(wb, `report_${new Date().getTime()}.xlsx`);
        });

        exportWordBtn.addEventListener('click', () => {
            if (reportItems.length === 0) return alert('No items in report to export');

            const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, HeadingLevel } = docx;

            const tableHeaderRow = new TableRow({
                children: headers.map(h => new TableCell({
                    children: [new Paragraph({ text: h, bold: true })],
                    shading: { fill: "f2f2f2" }
                }))
            });

            const tableDataRows = reportItems.map(item => {
                return new TableRow({
                    children: headers.map(h => new TableCell({
                        children: [new Paragraph({ text: String(item[h] || '') })]
                    }))
                });
            });

            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({
                            text: "Consolidated Report",
                            heading: HeadingLevel.HEADING_1,
                            spacing: { after: 200 }
                        }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: [tableHeaderRow, ...tableDataRows]
                        })
                    ]
                }]
            });

            Packer.toBlob(doc).then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `report_${new Date().getTime()}.docx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        });
    </script>
</body>
</html>
